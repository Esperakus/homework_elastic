# Домашняя работа "Централизованный сбор логов в кластре Elasticsearch"

Цель работы - в существующем проекте добавить централизованный сбор логов через ELK.

Данный репозиторий содержит:

- Манифесты terraform для создания инфраструктуры проекта:
  - штатный балансировщик yandex.cloud, который будет проводить периодически health-check воркеров nginx и балансировать входящий трафик между ними
  - 2 воркера nginx, которые в свою очередь настроены на простейшую балансировку трафика на бэкенды веб приложения
  - 2 воркера бэкенда, на которых в systemd запущено простейшее приложение на go, слушающее порт 8090. При запросе отдаёт имя бэкенда (чтобы понять, на какой бэкенд прилетел запрос из Nginx) и версию БД
  - 1 iscsi target, раздающий диск в бэкенды
  - 1 экземпляр БД Postgresql 13 c базой test и пользователем БД test, чтоб принимать запросы от бэкенда
  - три ноды кластера Elasticsearch
  - 1 экземпляр kibana + logstash с внешним ip
  - и, наконец, виртуалка с установленным ансиблем, чтоб развернуть вышеупомянутые роли. Выступает так же в роли Jump host проекта

- Роли ansible для приведения виртуальных машин в проекте в требуемое состояние.

Все виртуальные машины на AlmaLinux 8.

Для разворачивания стенда необходимо:

1. Заполнить значение переменных cloud_id, folder_id и iam-token в файле **variables.tf**.

2. Инициализировать рабочую среду Terraform:

```
$ terraform init
```
В результате будет установлен провайдер для подключения к облаку Яндекс.

3. Запустить разворачивание стенда:
```
$ terraform apply
```
В выходных данных будут показаны все внешние и внутренни ip адреса. Для проверки работы стенда необходимо в браузере или с помощью curl зайти на ip адрес балансировщика yandex.cloud, который можно посмотреть в выходных данных, например:

```
Пример вывода terraform apply:

...
external_ip_address_lb = tolist([
  {
    "external_address_spec" = toset([
      {
        "address" = "51.250.84.78"
        "ip_version" = "ipv4"
...
```
Через некоторое время можно зайти на адреса http://{kibana-ip}:5601/app/observability/overview и http://{kibana-ip}:5601.app/logs/stream и увидеть, что  производится сбор логов всех узлов проекта с помощью filebeat.